name: üß™ Deploy to Development
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Source branch'
        required: true
        type: choice
        options: [dev]
      plugin-directory:
        description: 'Select plugin from mod/'
        required: true
        type: choice
        options: ${{ fromJson(steps.list-plugins.outputs.plugins) }}
env:
  MOODLE_ROOT: /var/www/html/moodle-dev
jobs:
  package-plugin:
    name: üì¶ Package Plugin
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}
    - name: List available plugins
      id: list-plugins
      run: |
        PLUGINS=$(ls -d mod/*/ | cut -d/ -f2 | jq -R -s -c 'split("\n")[:-1]')
        echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT
    - name: Create plugin package
      run: |
        zip -rq ${{ inputs.plugin-directory }}.zip mod/${{ inputs.plugin-directory }}
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dev-plugin
        path: ${{ inputs.plugin-directory }}.zip
        retention-days: 1
  deploy-dev:
    name: üñ•Ô∏è Deploy to Development
    needs: package-plugin
    runs-on: [self-hosted, dev]
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: dev-plugin
    - name: Deploy plugin
      run: |
        sudo unzip -qo *.zip -d "${{ env.MOODLE_ROOT }}/mod"
        sudo chown -R www-data:www-data "${{ env.MOODLE_ROOT }}/mod/${{ inputs.plugin-directory }}"
        echo "‚úÖ Successfully deployed ${{ inputs.plugin-directory }} to development"