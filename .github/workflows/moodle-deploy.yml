name: Moodle Plugin Deployment Workflow

on:
  workflow_dispatch: # Enables manual trigger

jobs:
  deploy:
    name: Deploy Moodle Plugin
    runs-on: self-hosted

    env:
      MOODLE_SERVER_PATH: /var/www/html/moodle/mod/ # Moodle plugins directory

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch at least 2 commits to compare changes

      # Step 2: Detect changed directories under /mod
      - name: Detect Changed Directories
        id: detect_changes
        run: |
          # Ensure we fetch sufficient history
          git fetch --depth=10

          # Get the list of changed directories under 'mod/'
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep '^mod/' | cut -d '/' -f2 | sort | uniq)
          else
            echo "Less than 2 commits in history; checking changes in the last commit."
            CHANGED_DIRS=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^mod/' | cut -d '/' -f2 | sort | uniq)
          fi

          # Check if any directories were detected
          if [ -z "$CHANGED_DIRS" ]; then
            echo "No changed directories detected."
            exit 1
          fi

          echo "Changed directories: $CHANGED_DIRS"
          echo "::set-output name=changed_dirs::$CHANGED_DIRS"

      # Step 3: Create ZIP Artifacts for changed directories
      - name: Create ZIP Artifacts
        run: |
          mkdir -p /home/ubuntu/artifact
          for DIR in ${{ steps.detect_changes.outputs.changed_dirs }}; do
            echo "Creating ZIP for directory: $DIR"
            cd mod/$DIR
            zip -r /home/ubuntu/artifact/${DIR}.zip ./*
            cd ../../
            echo "Created artifact: /home/ubuntu/artifact/${DIR}.zip"
          done

      # Step 4: Backup Existing Directories
      - name: Backup Existing Directories
        run: |
          for DIR in ${{ steps.detect_changes.outputs.changed_dirs }}; do
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            
            # Check if the directory exists before backing up
            if [ -d "${{ env.MOODLE_SERVER_PATH }}${DIR}" ]; then
              echo "Backing up directory: ${{ env.MOODLE_SERVER_PATH }}${DIR}"
              sudo zip -r /tmp/${DIR}_backup_${TIMESTAMP}.zip ${{ env.MOODLE_SERVER_PATH }}${DIR}/
              echo "Backup created: /tmp/${DIR}_backup_${TIMESTAMP}.zip"
            else
              echo "Directory does not exist: ${{ env.MOODLE_SERVER_PATH }}${DIR}. Skipping backup."
            fi
          done

      # Step 5: Deploy the Plugin ZIPs to Moodle server
      - name: Deploy Plugin
        run: |
          for DIR in ${{ steps.detect_changes.outputs.changed_dirs }}; do
            echo "Deploying plugin for directory: ${DIR}"

            # Unzip the artifact directly on the server
            sudo unzip -o /home/ubuntu/artifact/${DIR}.zip -d /var/www/html/moodle/mod/
            sudo chown -R www-data:www-data /var/www/html/moodle/mod/
            sudo chmod -R 755 /var/www/html/moodle/mod/
            sudo -u www-data /usr/bin/php /var/www/html/moodle/admin/cli/upgrade.php --non-interactive

            echo "Plugin deployed and Moodle upgraded successfully."
          done
